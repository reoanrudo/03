# Phase 4-3: 既存機能との互換性確認

## 目的
曲学習機能を実装した後、既存の演奏機能に悪影響がないことを確認する。

## 前提条件
- [ ] 開発サーバーが起動していること
- [ ] 手動テスト Phase 4-1, 4-2 が完了していること
- [ ] 2つのデバイスまたはブラウザタブを用意できること

## テスト手順

### テスト1: モード切替 - PC PlayerとMobile Controllerの正常動作

**操作**:
1. メイン画面（Lobby）を表示
2. 「PC Player」を選択 → SongSelector画面を表示
3. 新しいブラウザタブを開いて、同じルームIDで「Mobile Controller」を選択

**期待される結果**:
- [ ] 両方の画面が正しく表示されていること
- [ ] SongSelector画面（PC側）で曲が選択できること
- [ ] Mobile Controller画面でフレット操作ができること
- [ ] WebRTC 接続が確立されること（「Linked」表示）

### テスト2: 曲を選択しないモード - 既存の演奏機能

**目的**: 曲を選択せずに既存の演奏モードを確認

**操作**:
1. SongSelector画面で演奏開始ボタンをクリックせずに戻るボタンをクリック（または別の曲を選択）
2. 直接演奏開始を選択した場合、既存のモードが動作することを確認

**注意点**:
- 現在の実装では、曲を選択しない場合、PC Playerはランダムノーツモードで動作します
- これは既存の演奏機能と同じ動作です

**期待される結果**:
- [ ] 曲を選択しない演奏モードが正常に動作すること
- [ ] ノーツがランダムに生成されること
- [ ] 既存のスコアシステムが機能すること

### テスト3: WebRTC通信の確認

**操作**:
1. PC Playerを1つのデバイス/タブで開く
2. Mobile Controllerを別のデバイス/タブで開く
3. 同じルームID（4文字）を入力する

**期待される結果**:
- [ ] WebRTC 接続が確立されること（「Linked」表示）
- [ ] PC PlayerがMobile Controllerからのフレット更新を受け取れること
- [ ] Mobile Controllerのボタン操作がPC Playerに転送されること
- [ ] 遅延がなくリアルタイムに動作すること

### テスト4: コンボシステムの動作

**操作**:
1. 連続してノーツをヒットする
2. コンボ数の表示を確認する

**期待される結果**:
- [ ] コンボ数が正しくカウントアップすること
- [ ] コンボが5以上になるとスコアラインの色がオレンジになること
- [ ] ノーツをミスするとコンボが0にリセットされること

### テスト5: オーディオシステムの動作

**操作**:
1. 演奏を開始する（GIG START ボタンをクリック）
2. ノーツをヒットする

**期待される結果**:
- [ ] ヒット時にオーディオが再生されること
- [ ] ミス時にミュートされた音が再生されること
- [ ] 複数のノーツを同時にヒットした場合でも正しく再生されること

### テスト6: ビジュアルエフェクトの動作

**操作**:
1. ノーツをヒットする

**期待される結果**:
- [ ] パーティクルエフェクトが表示されること
- [ ] ヒット時のアニメーション（PERFECT/GREAT 評価）が表示されること
- [ ] ミス時の MISS 表示が表示されること

### テスト7: スコアシステムの動作

**操作**:
1. 演奏を開始してノーツをヒットする
2. スコアの表示を確認する

**期待される結果**:
- [ ] PERFECT ヒット: 1000 点が加算されること
- [ ] GREAT ヒット: 500 点が加算されること
- [ ] スコアが正しく累計されていること
- [ ] スコア表示がリアルタイムに更新されること

### テスト8: 進捗システムと既存機能の競合

**目的**: 進捗システムが既存の演奏機能と競合しないことを確認

**操作**:
1. 進捗のある曲を選択して演奏する
2. 演奏終了時に進捗が更新されることを確認

**期待される結果**:
- [ ] 進捗が更新されても演奏中の動作に影響がないこと
- [ ] 既存のスコアシステムが正常に動作すること
- [ ] リロード後に進捗が正しく読み込まれること

### テスト9: レスポンシブデザイン

**操作**:
1. ブラウザウィンドウサイズを変更する

**期待される結果**:
- [ ] SongSelector でタブレットレイアウトが維持されること
- [ ] PC Player のキャンバスが正しくサイズ調整されること
- [ ] モバイルサイズ（スマートフォン）でも正しく表示されること

### テスト10: 既存コードの動作

**操作**:
1. 演奏中に以下のフレットパターンを確認

| コード | フレットパターン（弦6本） |
|-------|------------------------|
| C | 0, 1, 0, 2, 3, 0 |
| G | 3, 0, 0, 0, 2, 3 |
| D | 2, 3, 2, 0, 0, 0 |
| Am | 0, 1, 2, 2, 0, 0 |
| E | 0, 2, 2, 1, 0, 0 |
| A | 0, 0, 2, 2, 2, 0 |
| Dm | 2, 3, 2, 0, 1, 0 |
| Em | 0, 2, 2, 0, 0, 0 |

**期待される結果**:
- [ ] 各コードのフレットパターンが正しく動作すること
- [ ] コード名が正しく表示されること
- [ ] 複数の指で同じコードを押せること

### テスト11: ストラム判定の動作

**操作**:
1. 手を腰の高さ（ストラムゾーン）で上下に素早く振る
2. ノーツがヒットゾーンにあるタイミングでストラムする

**期待される結果**:
- [ ] ストラムが正しく検知されること（手がオレンジ色で表示される）
- [ ] ノーツがヒットすること
- [ ] ミスしないこと

### テスト12: 画面切り替えと状態管理

**操作**:
1. 以下の画面遷移をテストする：
   - Lobby → SongSelector → PC Player
   - PC Player → Lobby → SongSelector
   - Mobile Controller → Lobby → PC Player

**期待される結果**:
- [ ] 画面遷移がスムーズであること
- [ ] 各画面の状態が正しくリセットされること
- [ ] メモリリークが発生しないこと

## 互換性チェックリスト

### 機能互換性
- [ ] 既存のPC MODE演奏が正常に動作すること
- [ ] 既存のMOBILE MODEが正常に動作すること
- [ ] WebRTC通信が機能すること
- [ ] 既存のコンボシステムが機能すること
- [ ] 既存のスコアシステムが機能すること
- [ ] 既存のオーディオシステムが機能すること
- [ ] 既存のビジュアルエフェクトが機能すること

### データ互換性
- [ ] 新機能の進捗データが既存の機能と競合しないこと
- [ ] localStorage が正しく管理されていること
- [ ] 複数のタブ間でデータが整合していること

### UI/UX 互換性
- [ ] レスポンシブデザインが維持されていること
- [ ] モバイル対応が維持されていること
- [ ] アニメーションがスムーズであること
- [ ] ユーザー体験が低下していないこと

## 既知の制限事項

### 既存の機能
- 曲選択しない場合、ランダムノーツモードで動作
- ノーツのヒット判定は既存のロジックを使用
- コンボリセットのタイミングは既存の設定に従う

### 新機能
- 進捗データは演奏終了時にのみ更新
- 進捗は曲ごとに管理される
- クリア判定はヒット率 80% 以上

## バグ報告テンプレート

```
テスト項目:
期待される結果:
実測結果:
互換性有無:
バグの詳細:
影響範囲:
```

## テスト完了後の次のステップ

全てのテストを完了したら：
1. 互換性に問題がない場合、「互換性確認完了」をマークする
2. 問題が見つかった場合、詳細を記録して修正を計画する
3. Phase 4-4（パフォーマンス最適化）に進む
