# Phase 4-2: 進捗保存・読み込みのテスト

## 目的
ProgressServiceのlocalStorage連携が正常に機能することを確認する。

## 前提条件
- [ ] 開発サーバーが起動していること
- [ ] SongSelector画面が表示されていること
- [ ] 手動テストPhase 4-1が完了していること

## テスト手順

### テスト1: 初回演奏 - 進捗データの作成

**操作**:
1. 任意の曲（例: きらきら星（初級））を選択
2. 「演奏開始」ボタンをクリック
3. 数秒間演奏する（または曲が終了するまで待つ）

**期待される結果**:
- [ ] 演奏が開始されること
- [ ] スコアが表示されていること
- [ ] 演奏終了時に「曲クリア！」または「演奏終了」メッセージが表示されること

### テスト2: localStorageの確認 - データが保存されていること

**操作**:
ブラウザの開発者ツールを開いて、以下の手順でlocalStorageを確認します：

1. 開発者ツールを開く（F12 または Cmd+Option+I）
2. 「Application」タブをクリック
3. 左側メニューから「Local Storage」を展開
4. 「http://localhost:3000」をクリック

**期待される結果**:
- [ ] `air-guitar-progress` というキーが存在すること
- [ ] 値が JSON 配列であること
- [ ] 演奏した曲のデータが含まれていること

**データ構造の確認**:
```json
[
  {
    "songId": "twinkle-easy",
    "bestScore": 5000,
    "clearCount": 0,
    "lastPlayed": "2026-01-29T08:30:00.000Z"
  }
]
```

### テスト3: リロード後の進捗表示

**操作**:
1. ページをリロードする（Cmd+R または F5）
2. SongSelector画面を表示

**期待される結果**:
- [ ] 進捗データが維持されていること
- [ ] ベストスコアとクリア回数が表示されていること
- [ ] カードに「ベストスコア」和「クリア回数」セクションが表示されていること

### テスト4: 複数回演奏 - ベストスコアの更新

**操作**:
1. 同じ曲を再選択
2. 前回より高いスコアを目指して演奏する

**期待される結果**:
- [ ] 演奏終了時にベストスコアが更新されていること
- [ ] スコアが前回より高くなっていること

### テスト5: クリア判定 - クリア回数の増加

**操作**:
1. 難易度が低い曲（初級）で80%以上のヒット率を目指す
2. 完全に近い演奏を目指す

**期待される結果**:
- [ ] 演奏終了時に「曲クリア！」メッセージが表示されること
- [ ] クリア回数が増加していること（1回増加）
- [ ] メッセージの色が緑色（`#22c55e`）であること

### テスト6: 未クリア演奏 - クリア回数の増加なし

**操作**:
1. わざと低いスコアで演奏する
2. 多くのノーツをミスする

**期待される結果**:
- [ ] 演奏終了時に「演奏終了」メッセージが表示されること
- [ ] クリア回数が増加していないこと（0回のまま）
- [ ] メッセージの色が青色（`#94a3b8`）であること

### テスト7: localStorageの削除 - リセット機能

**操作**:
1. 開発者ツールの「Application」タブを開く
2. Local Storage から `air-guitar-progress` を削除
3. ページをリロードする

**期待される結果**:
- [ ] 進捗情報が表示されないこと
- [ ] カードに「ベストスコア」和「クリア回数」セクションが表示されないこと
- [ ] 新しい演奏を開始すると、新しくデータが保存されること

### テスト8: 複数曲の進捗

**操作**:
1. 複数の曲を演奏する
2. それぞれの曲で異なるスコアを記録する
3. ページをリロードする

**期待される結果**:
- [ ] 全ての曲の進捗データが保存されていること
- [ ] 各曲のベストスコアとクリア回数が正しく表示されていること
- [ ] localStorage に複数の曲データが含まれていること

## localStorageデータ構造の詳細

### Progress インターフェース
```typescript
interface Progress {
  songId: string;      // 曲ID
  bestScore: number;   // ベストスコア
  clearCount: number;   // クリア回数
  lastPlayed: string;   // 最終演奏日時（ISO形式）
}
```

### localStorage キー
- キー名: `air-guitar-progress`
- 値: `Progress[]` （JSON 配列）

## トラブルシューティング

### 問題: 進捗が保存されない

**考えられる原因**:
1. localStorage が無効化されている
2. ブラウザのプライベートモード
3. ProgressService のバグ

**解決方法**:
1. 開発者ツールで localStorage の設定を確認
2. プライベートモードをオフにする
3. コンソールでエラーを確認

### 問題: リロード後進捗が消える

**考えられる原因**:
1. localStorage の容量制限
2. ブラウザのデータ消去設定
3. 保存エラー（例外が発生）

**解決方法**:
1. ブラウザのストレージ設定を確認
2. コンソールのエラーログを確認
3. `ProgressService.saveProgress()` のエラーハンドリングを確認

## テスト完了チェックリスト

### 基本機能テスト
- [ ] テスト1: 初回演奏で進捗データが作成されること
- [ ] テスト2: localStorage に進捗データが保存されること
- [ ] テスト3: リロード後進捗データが読み込まれること
- [ ] テスト4: ベストスコアが正しく更新されること
- [ ] テスト5: クリア回数が正しく増加すること
- [ ] テスト6: 未クリア演奏でクリア回数が増加しないこと
- [ ] テスト7: localStorage 削除でリセットが機能すること
- [ ] テスト8: 複数曲の進捗が正しく管理されること

### データ整合性テスト
- [ ] songId が正しく設定されていること
- [ ] bestScore が数値として保存されていること
- [ ] clearCount が数値として保存されていること
- [ ] lastPlayed が ISO 8601 形式で保存されていること

## バグ報告テンプレート

```
テスト項目:
期待される結果:
実測結果:
バグ有無:
備考:
再現手順:
```

## テスト完了後の次のステップ

全てのテストを完了したら：
1. バグが見つかった場合、詳細を記録する
2. バグがない場合、「正常動作」をマークする
3. Phase 4-3（既存機能との互換性確認）に進む
