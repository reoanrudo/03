# 要件定書: 曲学習機能（Song Learning Feature）

## 概要

演奏者が曲を弾くことで上達を学ぶための機能。初心者用の簡単な曲から開始でき、F2~F13のフレット位置表示を曲に沿ったコード譜表示に変更する。

---

## 機能要件
### FR-1: 曲データの管理
- 説明: 曲情報（曲名、アーティスト、難易度、BPM、コード譜）を管理する機能
- 受け入れ基準:
  - 曲名、アーティスト、難易度、BPM、コード譜を定義できること
  - 難易度は「初級」「中級」「上級」の3段階で分類できること
  - コード譜は時系列でコード名とフレット位置を指定できること
  - サンプルデータとして最低3曲（初級1曲、中級1曲、上級1曲）を含むこと

### FR-2: 曲選択画面
- 説明: ユーザーが演奏する曲を選択する画面
- 受け入れ基準:
  - 曲リストを一覧表示できること
  - 難易度でフィルタリングできること
  - 難易度ごとの色分け表示（初級: 緑、中級: 黄色、上級: 赤）があること
  - 曲を選択して演奏を開始できること
  - 既存のPC MODEの前に曲選択画面が表示されること

### FR-3: コード譜表示
- 説明: 演奏中にノーツにコード名を表示する機能
- 受け入れ基準:
  - ノーツ上にコード名（C, G, D, Amなど）を表示できること
  - 既存のF2~F13表示をコード名表示に置き換えること
  - コード名が認識されない場合（不明なフレットパターン）はフレット位置を表示すること
  - コードチェンジのタイミングを視覚的に認識できること

### FR-4: 学習進捗管理
- 説明: ユーザーの学習進捗を記録・表示する機能
- 受け入れ基準:
  - 各曲のベストスコアを記録できること
  - 各曲のクリア回数を記録できること
  - 全体の進捗（クリアした曲の数/全曲数）を表示できること
  - 初心者が最初の曲をクリアした時に達成メッセージを表示すること

### FR-5: データベース統合
- 説明: 曲データ、ユーザー進捗、カスタム曲などをサーバー側のデータベースで管理する機能
- 受け入れ基準:
  - サーバー側データベース（SQLiteまたはPostgreSQL）への曲データ移行
  - ユーザー進捗データのクラウド同期
  - カスタム曲のアップロードと保存
  - プレイリストの保存・共有
  - データのバックアップと復元

### FR-6: ユーザー認証システム
- 説明: ユーザー登録、ログイン、ログアウト機能
- 受け入れ基準:
  - メールアドレスとパスワードで登録できること
  - セッション管理が適切に行われること
  - ログアウト機能があること
  - パスワードリセット機能があること

### FR-7: ログ・セッション管理
- 説明: ユーザーの演奏履歴、セッション情報を記録・表示する機能
- 受け入れ基準:
  - 各ユーザーの演奏履歴を記録できること
  - 直近の演奏セッションを再開できること
  - セッション情報の表示ができること

### FR-8: カスタム曲のアップロード機能
- 説明: ユーザーが独自の曲データをアップロードできる機能
- 受け入れ基準:
  - JSONまたはMIDI形式の曲データをアップロードできること
  - アップロードした曲を演奏できること
  - 曲の共有・公開設定ができること
  - 曲の検索とフィルタリングができること

### FR-9: オンラインランキング機能
- 説明: 全ユーザーのスコアを集計してランキングを表示する機能
- 受け入れ基準:
  - 全ユーザーのスコアを集計して表示できること
  - 週間・月間ランキングを表示できること
  - ユーザーごとのベストスコアを表示できること

### FR-10: 練習モード機能
- 説明: 曲の速度調整、ループ再生、特定セクションの反復練習ができる機能
- 受け入れ基準:
  - 再生速度を調整できること（0.5x, 0.75x, 1.0xなど）
  - 特定セクションをループ再生できること
  - 特定フレーズの反復練習ができること

### FR-11: 演奏統計機能
- 説明: ユーザーの演奏統計（合計演奏時間、最も演奏した曲、平均スコアなど）を表示する機能
- 受け入れ基準:
  - 合計演奏時間を表示できること
  - 最も演奏した曲を表示できること
  - 平均スコアを表示できること
  - コードマスター度を表示できること

---

## 非機能要件

### NFR-1: 初心者フレンドリーなUI/UX
- カテゴリ: 可用性
- 説明: ギター初心者でも直感的に使用できるUI/UX
- 受け入れ基準:
  - 初心者用曲は1つの曲で使用するコードが3つ以下であること
  - 操作手順を最小限に抑えること
  - 日本語で分かりやすい説明があること

### NFR-2: リアルタイム演奏フィードバック
- カテゴリ: パフォーマンス
- 説明: 演奏中に遅延なくフィードバックを提供する
- 受け入れ基準:
  - WebRTC通信の遅延が100ms以内であること
  - 音声再生が視覚的判定と同期していること
  - ノーツの判定が正確（HIT_WINDOW内）に行われること

### NFR-3: 段階的難易度システム
- カテゴリ: 可用性
- 説明: 初心者から上級者まで段階的に難易度が上がる設計
- 受け入れ基準:
  - 初級曲: 使用コード3種類以下、BPM 60-80
  - 中級曲: 使用コード4-6種類、BPM 80-100
  - 上級曲: 使用コード7種類以上、BPM 100以上

### NFR-4: 既存機能との互換性
- カテゴリ: 互換性
- 説明: 既存の演奏機能に影響を与えずに新機能を追加する
- 受け入れ基準:
  - 既存のPC MODE、MOBILE MODEの動作に影響がないこと
  - 既存のスコアシステム、コンボシステムを継続して使用できること
  - 既存のコード判定ロジック（getCurrentChord）を活用すること

### NFR-5: データベースのセキュリティ
- カテゴリ: セキュリティ
- 説明: データベースへのアクセス制御とSQLインジェクション防止
- 受け入れ基準:
  - ユーザーごとのデータ分離が適切に行われること
  - パラメータ化されたクエリを使用すること
  - SQLインジェクションが防止されていること
  - データの暗号化が適切に行われること

### NFR-6: APIのレート制限
- カテゴリ: パフォーマンス
- 説明: APIエンドポイントの呼び出し回数を制限して過負荷を防ぐ
- 受け入れ基準:
  - 各エンドポイントにレート制限が設定されていること
  - 短時間での過剰な呼び出しが防止されていること

### NFR-7: 認証情報の保護
- カテゴリ: セキュリティ
- 説明: パスワードのハッシュ化、セッショントークンの保護
- 受け入れ基準:
  - パスワードはハッシュ化されて保存されること
  - セッショントークンは安全に管理されていること
  - HTTPS通信が推奨されていること

### NFR-8: 認証情報のセキュリティ
- カテゴリ: セキュリティ
- 説明: ユーザー情報の取り扱いとプライバシー保護
- 受け入れ基準:
  - ユーザー情報の取り扱いが適法に遵守されていること
  - 不要な情報の収集が行われていないこと
  - データの削除リクエストが適切に実装されていること

### NFR-9: データのプライバシー保護
- カテゴリ: プライバシー
- 説明: ユーザーの演奏データと進捗情報の適切な保護
- 受け入れ基準:
  - 他のユーザーの演奏データは閲覧できないこと
  - 個人的な進捗情報は共有されないこと
  - 統計情報は公開範囲のみで表示されること

---

## 制約条件

### TC-1: 技術スタック
- React 19 + TypeScript + Vite
- Tone.js（音声生成）
- TensorFlow.js HandPose（ハンドトラッキング）
- WebRTC（P2P通信）

### TC-2: 既存コードベースの制約
- MobileControllerは4フレットまでしか操作できない（totalFrets = 4）
- 既存のコード定義（C, G, D, Am, E, A, Dm, Em）を拡張または活用する
- 既存のノーツ生成ロジック（spawnNote）を曲データベースに置き換える

### TC-5: データベース技術
- SQLite開発環境、PostgreSQL本番環境
- ORM（SQLAlchemyまたはPrisma）

### TC-6: 認証方式
- JWT（JSON Web Token）またはOAuth2.0
- セッショントークン管理

### TC-7: セキュリティ
- HTTPS通信
- CORSの適切な設定
- データの暗号化（AES-256など）

### TC-4: UI言語
- UI、エラーメッセージ、説明は日本語優先
- 技術用語（WebRTC、WebSocket、TypeScript）は英語のまま

---

## 受け入れ基準（総合）

### AC-1: 基本機能
- [x] 曲選択画面が表示されること
- [x] 曲を選択して演奏を開始できること
- [x] ノーツ上にコード名が表示されること
- [x] スコアと進捗が記録されること

### AC-2: 初心者向け設計
- [x] 初級曲が1曲以上存在すること
- [x] 初心者が最初の曲をクリアできること
- [x] 難易度フィルタリングが機能すること

### AC-3: 互換性
- [x] 既存の演奏機能が正常に動作すること
- [x] 既存のWebRTC通信が機能すること

---
## 今後の拡張計画

### Phase 5: サーバー側移行
- サーバー側で曲データベースの管理
- ユーザーアカウントとクラウド同期
- オンラインランキング機能

### Phase 6: 高度機能
- カスタム曲のアップロード機能
- 練習モード機能
- 演奏統計機能
- マルチプレイヤーモード（複数ユーザーでの演奏）

- サーバー側で曲データベースの管理
- ユーザーアカウントとクラウド同期
- オンラインランキング機能
- カスタム曲のアップロード機能
